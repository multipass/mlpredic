---
title: 'Reproducible Research Assignment #2 (June 2016)'
author: "Yann K."
output: html_document
---

##Executive Summary
The US National Oceanic and Atmospheric Administration (NOAA) tracks the characteristics (estimation of the injuries, fatalities and property damages) of the major storms and weather events in a database. The dataset used in this project holds records of catastrophic weather events between the years 1950 and 2011.
The storm data documentation is available at this [link]( https://d396qusza40orc.cloudfront.net/repdata%2Fpeer2_doc%2Fpd01016005curr.pdf)

The key findings from the exploration of the dataset are:

* Tornados are by the far the deadliest weather catastrophic events
* The floods in the state of California are by far the costliest weather catastrophic events, followed by hurricanes in the state of Louisiana 
 

##Data Processing
```{r, echo=TRUE, cache=TRUE}
library(ggplot2)
top<-20
file.remote<-"https://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2"
file.local<-"data.csv.bz2"
download.file(file.remote,file.local,method="curl")
df<-read.csv(file.local)
#For this study we will look at the fields
#STATE, EVTYPE, FATALITIES, INJURIES, 
#PROPDMG, PROPDMGEXP, CROPDMG, CROPDMGEXP
df<-df[,grepl("DMG|^STATE$|EVTYPE|FATAL|INJ", names(df))]
str(df)
```



##Top 20 Casualties number by weather event type
* Tornados are by far the deadliest weather type of event by causing almost 10 times more casualties than the second in the list
* Excessive heat, thunderstorm winds, floods and lightning are causing a relatively equivalent number of casualties and are statistically the second group of catastrophic weather events

```{r, echo=TRUE, fig.align="center", cache=TRUE}
#Group and count the fatalities by weather event types
fat<-aggregate(FATALITIES~EVTYPE, df, sum)
fat$CATEGORY<-"Fatality"
fat$COUNT<-fat$FATALITIES
fatal<-fat[,c(1,3,4)]

#Group and count the injuries by weather event types
inj<-aggregate(INJURIES~EVTYPE, df, sum)
inj$CATEGORY<-"Injury"
inj$COUNT<-inj$INJURIES
inju<-inj[,c(1,3,4)]

#Combine injuries and fatalities in a common dataframe
evt<-rbind(fatal, inju)
evt$CATEGORY<-factor(evt$CATEGORY)

#Get the top #20 weather events by number of casualties
evt.fat<-evt[evt$CATEGORY=="Fatality",]
evt.fat<-head(evt.fat[order(-evt.fat$COUNT),],n=top)
evt.inj<-evt[evt$CATEGORY=="Injury",]
evt.inj<-head(evt.inj[order(-evt.inj$COUNT),],n=top)
evt.summary<-rbind(evt.fat, evt.inj)

#Plot top #20
g<-ggplot(data=evt.summary)
g<-g+geom_bar(aes(x=reorder(EVTYPE, -COUNT), y=COUNT, fill=CATEGORY), stat="identity") 
g<-g+coord_flip()
g<-g+xlab("Weather Event")
g<-g+ylab("# Casualties")
g<-g+ggtitle("Top #20 Severe weather events")
g
```




##Top 20 Costliest weather events by state
* The floods in California are by far the costliest weather events
* Storm surges and hurricanes/typhoons in Louisiana are the second costliest weather type events

```{r, echo=TRUE, fig.align="center", cache=TRUE}
#Utility function to compute the dollar amount using a unit measure
#h or H for x100
#k or K for x1,000
#m or M for x1,000,000
#b or B for x1,000,000,000
dollarAmount<-function(amount, unit) amount*switch(toupper(unit),B=1E9,M=1E6,K=1E3,H=1E2,1) 

#Add extra columns to the dataframe with the dollar amount equivalent
df$PROPAMT<-mapply(dollarAmount, df$PROPDMG, df$PROPDMGEXP)
df$CROPAMT<-mapply(dollarAmount, df$CROPDMG, df$CROPDMGEXP)

#Total dollar amount from crop damages and property damages
df$TOTAMT<-df$PROPAMT+df$CROPAMT

#Group total amount per weather event and state, and take the top #20
dmgByEvt<-aggregate(TOTAMT~EVTYPE+STATE, df, sum)
dmgByEvt<-head(dmgByEvt[order(-dmgByEvt$TOTAMT),], n=top)
str(dmgByEvt)

#Plot top #20
g<-ggplot(data=dmgByEvt)
g<-g+geom_bar(aes(x=reorder(EVTYPE,-TOTAMT), y=TOTAMT, fill=STATE), stat="identity") 
g<-g+coord_flip()
g<-g+xlab("Weather Event")
g<-g+ylab("Cost of total damage (USD)")
g<-g+ggtitle("Top #20 Severe weather Damage Costs per state")
g
```


